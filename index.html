<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Infinity</title>
  <link href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css" rel="stylesheet">
  <style>
    body { background: #0e0e11; color: #f5f5f5; }
    .box { background: #1c1c22; }
    input, textarea { background: #2a2a2e; color: #f5f5f5; border: none; }
    .button.is-primary { background-color: #09d1b1; border: none; }
  </style>
</head>
<body>
<section class="section">
  <div class="container">
    <h1 class="title has-text-centered">Project Infinity Community</h1>
    <div id="auth" class="mb-5"></div>
    <div id="forum" class="is-hidden">
      <form id="post-form" class="box">
        <div class="field">
          <label class="label">Topic</label>
          <input class="input" type="text" id="post-title" required />
        </div>
        <div class="field">
          <label class="label">Message</label>
          <textarea class="textarea" id="post-body" required></textarea>
        </div>
        <button class="button is-primary">Post</button>
      </form>
      <div id="posts"></div>
    </div>
    <div id="loader" class="has-text-centered mt-5 is-hidden">
      <a href="loader/ProjectInfinityLoader.zip" class="button is-success">Download Loader</a>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
<script type="module">
  const supabaseUrl = 'https://YOUR_PROJECT_ID.supabase.co';
  const supabaseKey = 'YOUR_PUBLIC_ANON_KEY';
  const headers = { 'apikey': supabaseKey, 'Content-Type': 'application/json' };
  let currentUser = null;

  const authEl = document.getElementById('auth');
  const forumEl = document.getElementById('forum');
  const loaderEl = document.getElementById('loader');

  function showLogin() {
    authEl.innerHTML = `
      <div class="box">
        <div class="field">
          <label class="label">Username</label>
          <input class="input" id="username" />
        </div>
        <div class="field">
          <label class="label">Password</label>
          <input class="input" id="password" type="password" />
        </div>
        <div class="buttons">
          <button class="button is-primary" id="signup">Sign Up</button>
          <button class="button is-link" id="login">Log In</button>
        </div>
      </div>`;

    document.getElementById('signup').onclick = async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const hash = await bcrypt.hash(password, 10);
      await fetch(`${supabaseUrl}/rest/v1/users`, {
        method: 'POST',
        headers,
        body: JSON.stringify({ username, password_hash: hash })
      });
      alert('User created. Log in now.');
    };

    document.getElementById('login').onclick = async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const res = await fetch(`${supabaseUrl}/rest/v1/users?username=eq.${username}`, {
        headers
      });
      const users = await res.json();
      if (users.length && await bcrypt.compare(password, users[0].password_hash)) {
        currentUser = users[0];
        initApp();
      } else alert('Invalid credentials');
    };
  }

  function initApp() {
    authEl.innerHTML = `<div class="has-text-right"><button class="button is-small is-danger" onclick="location.reload()">Logout</button></div>`;
    forumEl.classList.remove('is-hidden');
    loaderEl.classList.remove('is-hidden');
    loadPosts();
  }

  async function loadPosts() {
    const res = await fetch(`${supabaseUrl}/rest/v1/posts?select=*`, { headers });
    const posts = await res.json();
    const postsEl = document.getElementById('posts');
    postsEl.innerHTML = posts.map(p => `
      <div class="box">
        <strong>${p.title}</strong>
        <p>${p.body}</p>
        <small>By ${p.username}</small>
      </div>`).join('');
  }

  document.getElementById('post-form').addEventListener('submit', async e => {
    e.preventDefault();
    const title = document.getElementById('post-title').value;
    const body = document.getElementById('post-body').value;
    await fetch(`${supabaseUrl}/rest/v1/posts`, {
      method: 'POST',
      headers,
      body: JSON.stringify({ title, body, username: currentUser.username })
    });
    e.target.reset();
    loadPosts();
  });

  showLogin();
</script>
</body>
</html>
