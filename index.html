<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Infinity</title>
  <link href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css" rel="stylesheet">
  <style>
    body { background: #0e0e11; color: #f5f5f5; }
    .box { background: #1c1c22; }
    input, textarea { background: #2a2a2e; color: #f5f5f5; border: none; }
    .button.is-primary { background-color: #09d1b1; border: none; }
  </style>
</head>
<body>
<section class="section">
  <div class="container">
    <h1 class="title has-text-centered">Project Infinity Community</h1>
    <div id="auth" class="mb-5"></div>
    <div id="forum" class="is-hidden">
      <form id="post-form" class="box">
        <div class="field">
          <label class="label">Topic</label>
          <input class="input" type="text" id="post-title" required />
        </div>
        <div class="field">
          <label class="label">Message</label>
          <textarea class="textarea" id="post-body" required></textarea>
        </div>
        <button class="button is-primary">Post</button>
      </form>
      <div id="posts"></div>
    </div>
    <div id="loader" class="has-text-centered mt-5 is-hidden">
      <a href="loader/ProjectInfinityLoader.zip" class="button is-success">Download Loader</a>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
<script>
const supabaseUrl = 'https://zgntqxmxcteaenerzncbu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnbnRxeG1jdGFlYW5lcnpuY2J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MTA5MjQsImV4cCI6MjA2NDI4NjkyNH0.yC1slPrw8wosSTKpHoYXWtFcIoTbcmplU9pYX9buWmM';
const headers = {
  'apikey': supabaseKey,
  'Content-Type': 'application/json'
};
let currentUser = null;

function showAuthUI() {
  document.getElementById('auth').innerHTML = `
    <div class="box">
      <div class="field">
        <label class="label">Username</label>
        <input class="input" id="username">
      </div>
      <div class="field">
        <label class="label">Password</label>
        <input class="input" id="password" type="password">
      </div>
      <div class="buttons">
        <button class="button is-primary" onclick="signup()">Sign Up</button>
        <button class="button is-link" onclick="login()">Log In</button>
      </div>
    </div>`;
}

async function signup() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const hash = await bcrypt.hash(password, 10);
  const res = await fetch(`${supabaseUrl}/rest/v1/users`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ username, password_hash: hash })
  });
  if (res.ok) {
    alert('Account created. You can now log in.');
  } else {
    alert('Signup failed. Username may already exist.');
  }
}

async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const res = await fetch(`${supabaseUrl}/rest/v1/users?username=eq.${username}`, { headers });
  const data = await res.json();
  if (data.length && await bcrypt.compare(password, data[0].password_hash)) {
    currentUser = username;
    loadApp();
  } else {
    alert('Invalid credentials');
  }
}

function loadApp() {
  document.getElementById('auth').innerHTML = `<div class="has-text-right"><button class="button is-small is-danger" onclick="logout()">Logout</button></div>`;
  document.getElementById('forum').classList.remove('is-hidden');
  document.getElementById('loader').classList.remove('is-hidden');
  loadPosts();
}

function logout() {
  currentUser = null;
  showAuthUI();
  document.getElementById('forum').classList.add('is-hidden');
  document.getElementById('loader').classList.add('is-hidden');
}

async function loadPosts() {
  const res = await fetch(`${supabaseUrl}/rest/v1/posts?select=*`, { headers });
  const data = await res.json();
  const postsEl = document.getElementById('posts');
  postsEl.innerHTML = data.map(p => `
    <div class="box">
      <strong>${p.title}</strong>
      <p>${p.body}</p>
      <small>By ${p.username}</small>
    </div>`).join('');
}

document.getElementById('post-form').addEventListener('submit', async e => {
  e.preventDefault();
  const title = document.getElementById('post-title').value;
  const body = document.getElementById('post-body').value;
  await fetch(`${supabaseUrl}/rest/v1/posts`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ title, body, username: currentUser })
  });
  e.target.reset();
  loadPosts();
});

showAuthUI();
</script>
</body>
</html>
